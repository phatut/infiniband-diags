.\" Man page generated from reStructeredText.
.
.TH INFINIBAND-DIAGS 8 "@BUILD_DATE@" "" "Open IB Diagnostics"
.SH NAME
INFINIBAND-DIAGS \- 
.
.nr rst2man-indent-level 0
.
.de1 rstReportMargin
\\$1 \\n[an-margin]
level \\n[rst2man-indent-level]
level margin: \\n[rst2man-indent\\n[rst2man-indent-level]]
-
\\n[rst2man-indent0]
\\n[rst2man-indent1]
\\n[rst2man-indent2]
..
.de1 INDENT
.\" .rstReportMargin pre:
. RS \\$1
. nr rst2man-indent\\n[rst2man-indent-level] \\n[an-margin]
. nr rst2man-indent-level +1
.\" .rstReportMargin post:
..
.de UNINDENT
. RE
.\" indent \\n[an-margin]
.\" old: \\n[rst2man-indent\\n[rst2man-indent-level]]
.nr rst2man-indent-level -1
.\" new: \\n[rst2man-indent\\n[rst2man-indent-level]]
.in \\n[rst2man-indent\\n[rst2man-indent-level]]u
..
.SH Diagnostics for InfiniBand Fabrics
.SS DESCRIPTION
.sp
infiniband\-diags is a set of utilities designed to help configure, debug, and
maintain infiniband fabrics.  Many tools and utilities are provided.  Some with
similar functionality.
.sp
The base utilities use directed route MAD\(aqs to perform their operations.  They
may therefore work even in unconfigured subnets.  Other, higher level
utilities, require LID routed MAD\(aqs and to some extent SA/SM access.
.SS THE USE OF SMPs (QP0)
.sp
Many of the tools in this package rely on the use of SMPs via QP0 to acquire
data directly from the SMA.  While this mode of operation is not technically in
compliance with the InfiniBand specification, practical experience has found
that this level of diagnostics is valuable when working with a fabric which is
broken or only partially configured.  For this reason many of these tools may
require the use of an MKey or operation from Virtual Machines may be restricted
for security reasons.
.SS COMMON OPTIONS
.sp
Most OpenIB diagnostics take some of the following common flags. The exact list
of supported flags per utility can be found in the documentation for those
commands.
.SS Addressing Flags
.sp
The \-D and \-G option have two forms:
.\" Define the common option -D for Directed routes
.
.sp
\fB\-D, \-\-Direct\fP     The address specified is a directed route
.sp
.nf
.ft C
Examples:
   [options] \-D [options] "0"          # self port
   [options] \-D [options] "0,1,2,1,4"  # out via port 1, then 2, ...

   (Note the second number in the path specified must match the port being
   used.  This can be specified using the port selection flag \(aq\-P\(aq or the
   port found through the automatic selection process.)
.ft P
.fi
.\" Define the common option -D for Directed routes
.
.sp
\fB\-D, \-\-Direct <dr_path>\fP     The address specified is a directed route
.sp
.nf
.ft C
Examples:
   \-D "0"          # self port
   \-D "0,1,2,1,4"  # out via port 1, then 2, ...

   (Note the second number in the path specified must match the port being
   used.  This can be specified using the port selection flag \(aq\-P\(aq or the
   port found through the automatic selection process.)
.ft P
.fi
.\" Define the common option -G
.
.sp
\fB\-G, \-\-Guid\fP     The address specified is a Port GUID
.\" Define the common option -G
.
.sp
\fB\-\-port\-guid, \-G <port_guid>\fP  Specify a port_guid
.\" Define the common option -L
.
.sp
\fB\-L, \-\-Lid\fP   The address specified is a LID
.\" Define the common option -s
.
.sp
\fB\-s, \-\-sm_port <smlid>\fP     use \(aqsmlid\(aq as the target lid for SA queries.
.SS Port Selection flags
.\" Define the common option -C
.
.sp
\fB\-C, \-\-Ca <ca_name>\fP    use the specified ca_name.
.\" Define the common option -P
.
.sp
\fB\-P, \-\-Port <ca_port>\fP    use the specified ca_port.
.\" Explanation of local port selection
.
.SS Local port Selection
.sp
Multiple port/Multiple CA support: when no IB device or port is specified
(see the "local umad parameters" below), the libibumad library
selects the port to use by the following criteria:
.INDENT 0.0
.INDENT 3.5
.INDENT 0.0
.IP 1. 3
.
the first port that is ACTIVE.
.IP 2. 3
.
if not found, the first port that is UP (physical link up).
.UNINDENT
.sp
If a port and/or CA name is specified, the libibumad library attempts
to fulfill the user request, and will fail if it is not possible.
.sp
For example:
.sp
.nf
.ft C
ibaddr                 # use the first port (criteria #1 above)
ibaddr \-C mthca1       # pick the best port from "mthca1" only.
ibaddr \-P 2            # use the second (active/up) port from the first available IB device.
ibaddr \-C mthca0 \-P 2  # use the specified port only.
.ft P
.fi
.UNINDENT
.UNINDENT
.SS Debugging flags
.\" Define the common option -d
.
.INDENT 0.0
.TP
.B \-d
.
raise the IB debugging level.
May be used several times (\-ddd or \-d \-d \-d).
.UNINDENT
.\" Define the common option -e
.
.INDENT 0.0
.TP
.B \-e
.
show send and receive errors (timeouts and others)
.UNINDENT
.\" Define the common option -h
.
.sp
\fB\-h, \-\-help\fP      show the usage message
.\" Define the common option -v
.
.INDENT 0.0
.TP
.B \fB\-v, \-\-verbose\fP
.sp
increase the application verbosity level.
May be used several times (\-vv or \-v \-v \-v)
.UNINDENT
.\" Define the common option -V
.
.sp
\fB\-V, \-\-version\fP     show the version info.
.SS Configuration flags
.\" Define the common option -t
.
.sp
\fB\-t, \-\-timeout <timeout_ms>\fP override the default timeout for the solicited mads.
.\" Define the common option -z
.
.INDENT 0.0
.TP
.B \fB\-\-outstanding_smps, \-o <val>\fP
.sp
Specify the number of outstanding SMP\(aqs which should be issued during the scan
.sp
Default: 2
.UNINDENT
.\" Define the common option --node-name-map
.
.sp
\fB\-\-node\-name\-map <node\-name\-map>\fP Specify a node name map.
.INDENT 0.0
.INDENT 3.5
.sp
This file maps GUIDs to more user friendly names.  See FILES section.
.UNINDENT
.UNINDENT
.\" Define the common option -z
.
.sp
\fB\-\-config, \-z  <config_file>\fP Specify alternate config file.
.INDENT 0.0
.INDENT 3.5
.sp
Default: @IBDIAG_CONFIG_PATH@/ibdiag.conf
.UNINDENT
.UNINDENT
.SS Check flags
.\" Define the common option -f
.
.sp
\fB\-f, \-\-check\fP  Check links against ibfabricconf.xml config.
.\" Define the common option --ibfabricconf
.
.sp
\fB\-\-ibfabricconf <ibfabricconf>\fP  Specify an alternate ibfabricconf.xml file (default: @IBDIAG_CONFIG_PATH@/ibfabricconf.xml)
.\" Define the common option --downnodes
.
.sp
\fB\-\-downnodes <nodelist>\fP
Specify nodes which are known to be off thus indicating that links to those
nodes are known to be down.  "nodelist" is a comma separated list of node
description names.
.\" Define the common option --smlid
.
.sp
\fB\-\-smlid <lid>\fP  Specify an smlid to verify on all active ports.
.\" Define the common option --addr-info
.
.sp
\fB\-\-addr\-info\fP  Print port GUID and LID information for the ports being reported as errors.
.\" Common text for the ibfabricconf file
.
.SS ibfabricconf.xml generation
.sp
Although not the intended use case is it understood that the generation of this
config file from an existing fabric can be very useful.  The following options
allow for this.
.sp
\fB\-\-generate\-config <config>\fP
Generate a config file from a scan of the fabric.  NOTE: this config file
is generic in nature as it does not include any link parameters such
as speed or width.  However, by default the speed and width is check against
the maximum supported by both ends of the link as reported by the hardware.
Should the user wish to support links operating below the maximum they can
alter this file as appropriate.
.sp
\fB\-\-ignore <regex>\fP when generating a config skip nodes matching <regex>
.sp
\fB\-\-missing\fP insert place holders for disconnected ports
.SS COMMON FILES
.sp
The following config files are common amongst many of the utilities.
.\" Common text for the config file
.
.SS CONFIG FILE
.sp
@IBDIAG_CONFIG_PATH@/ibdiag.conf
.sp
A global config file is provided to set some of the common options for all
tools.  See supplied config file for details.
.\" Common text to describe the node name map file.
.
.SS NODE NAME MAP FILE FORMAT
.sp
The node name map is used to specify user friendly names for nodes in the
output.  GUIDs are used to perform the lookup.
.sp
This functionality is provided by the opensm\-libs package.  See \fBopensm(8)\fP
for the file location for your installation.
.sp
\fBGenerically:\fP
.sp
.nf
.ft C
# comment
<guid> "<name>"
.ft P
.fi
.sp
\fBExample:\fP
.sp
.nf
.ft C
# IB1
# Line cards
0x0008f104003f125c "IB1 (Rack 11 slot 1   ) ISR9288/ISR9096 Voltaire sLB\-24D"
0x0008f104003f125d "IB1 (Rack 11 slot 1   ) ISR9288/ISR9096 Voltaire sLB\-24D"
0x0008f104003f10d2 "IB1 (Rack 11 slot 2   ) ISR9288/ISR9096 Voltaire sLB\-24D"
0x0008f104003f10d3 "IB1 (Rack 11 slot 2   ) ISR9288/ISR9096 Voltaire sLB\-24D"
0x0008f104003f10bf "IB1 (Rack 11 slot 12  ) ISR9288/ISR9096 Voltaire sLB\-24D"

# Spines
0x0008f10400400e2d "IB1 (Rack 11 spine 1   ) ISR9288 Voltaire sFB\-12D"
0x0008f10400400e2e "IB1 (Rack 11 spine 1   ) ISR9288 Voltaire sFB\-12D"
0x0008f10400400e2f "IB1 (Rack 11 spine 1   ) ISR9288 Voltaire sFB\-12D"
0x0008f10400400e31 "IB1 (Rack 11 spine 2   ) ISR9288 Voltaire sFB\-12D"
0x0008f10400400e32 "IB1 (Rack 11 spine 2   ) ISR9288 Voltaire sFB\-12D"

# GUID   Node Name
0x0008f10400411a08 "SW1  (Rack  3) ISR9024 Voltaire 9024D"
0x0008f10400411a28 "SW2  (Rack  3) ISR9024 Voltaire 9024D"
0x0008f10400411a34 "SW3  (Rack  3) ISR9024 Voltaire 9024D"
0x0008f104004119d0 "SW4  (Rack  3) ISR9024 Voltaire 9024D"
.ft P
.fi
.\" Common text for the ibfabricconf file
.
.SS IB FABRIC CONFIG FILE
.sp
NOTE: IB FABRIC CONFIG FILE support is only available when XML support was
enabled at build time.
.sp
@IBDIAG_CONFIG_PATH@/ibfabricconf.xml
.sp
This global config file is provided to describe the IB fabric to some of the
diagnostics for verification of the fabric.  This file provides a list of link
definitions which provide a "logical" view of the fabric via node names and
ports.  This config file also provides for the configuration of link
speed/width for sets of "links".
.sp
This config file has the following features:
.INDENT 0.0
.INDENT 3.5
.INDENT 0.0
.IP \(bu 2
.
A logical view of the fabric is described by this file. (ie entry\(aqs are
"name" based)
.INDENT 2.0
.INDENT 3.5
.sp
There are no GUID\(aqs, LIDs, etc.  As such misnamed nodes (possibly
supplied by the config file "ib\-node\-name\-map" or by
miss\-programmed node description fields) will show up as errors.
The reason for this is that this config file is designed to be used by
system admins to debug problems in a known network layout.  GUID\(aqs can
change as bad hardware is swapped out.  Therefore a logical view
of the fabric is much more useful and presented in
ibfabricconf.xml
.UNINDENT
.UNINDENT
.IP \(bu 2
.
Ports which are not specified are assumed to be down.
.INDENT 2.0
.INDENT 3.5
.sp
Checks during a fabric scan will report active links on those ports as errors.
.UNINDENT
.UNINDENT
.IP \(bu 2
.
Properties are inherited from parent to child in the XML.
.INDENT 2.0
.INDENT 3.5
.sp
For example if the entire fabric is to be 4X/QDR then only the
fabric XML tag needs to be specified as \(aqspeed="QDR" width="4X"\(aq.
However, any link/node specification can  have  properties  set
which overrides itself and it\(aqs children.
.UNINDENT
.UNINDENT
.IP \(bu 2
.
Ports which are listed a second time will over ride the previous entry.
.INDENT 2.0
.INDENT 3.5
.sp
This is very useful for overriding the internal links of the
large switches after using the "chassis" tag.  On the other hand
caution should be used in generating your config files.
.UNINDENT
.UNINDENT
.IP \(bu 2
.
Common "chassis" configs can be included using the "chassis" tag.
.INDENT 2.0
.INDENT 3.5
.sp
This makes defining the internal connections of large switches very
easy.  Using a chassis tag will automatically create all the internal
links for those switches.  The name of the chassis will be prepended to
the internal switches found in the chassis.  For example:
.sp
.nf
.ft C
<chassis name="ibcore1" model="QLogic_9240"></chassis>
.ft P
.fi
.sp
results to the following names:
.sp
.nf
.ft C
"ibcore1 SP1a", "ibcore1 SP1b", etc.

"ibcore1 L1a", "ibcore1 L2a", "ibcore1 Leaf 3 Chip A", etc.
.ft P
.fi
.sp
Internal switch names can be changed if the names used in the config file are not sufficient.
.INDENT 0.0
.INDENT 3.5
.sp
(See @IBDIAG_CONFIG_PATH@/chassis_fabricconfs for a list of
chassis which have alredy been defined.  Submissions of additional
chasis config files are always welcome.)
.UNINDENT
.UNINDENT
.UNINDENT
.UNINDENT
.IP \(bu 2
.
A "subfabric" tag allows you to specify the properties for a group of entries.
.UNINDENT
.UNINDENT
.UNINDENT
.sp
Example file:
.sp
.nf
.ft C
<?xml version="1.0" encoding="ISO\-8859\-1"?>
<!DOCTYPE ibfabric>

<ibfabric name="test fabric" schemaVersion="1.0">
        <property name="type">QSFP</property>
        <chassis name="test chassis" model="QLogic_9240"></chassis>
        <linklist name="SDR switch" speed="SDR">
                <port num="1"><r_port>1</r_port><r_node>SDR node</r_node></port>
        </linklist>
        <linklist name="DDR switch" speed="DDR">
                <port num="1"><r_port>1</r_port><r_node>DDR node</r_node></port>
        </linklist>
        <linklist name="QDR switch" speed="QDR">
                <port num="1"><r_port>1</r_port><r_node>QDR node</r_node></port>
        </linklist>
        <linklist name="FDR switch" speed="FDR">
                <port num="1"><r_port>1</r_port><r_node>FDR node</r_node></port>
        </linklist>
        <linklist name="FDR10 switch" speed="FDR10">
                <port num="1"><r_port>1</r_port><r_node>FDR10 node</r_node></port>
        </linklist>
        <linklist name="EDR switch" speed="EDR">
                <port num="1"><r_port>1</r_port><r_node>EDR node</r_node></port>
        </linklist>
        <linklist name="1x switch" width="1x">
                <port num="1"><r_port>1</r_port><r_node>1x node</r_node></port>
        </linklist>
        <linklist name="4x switch" width="4x">
                <port num="1"><r_port>1</r_port><r_node>4x node</r_node></port>
        </linklist>
        <linklist name="8x switch" width="8x">
                <port num="1"><r_port>1</r_port><r_node>8x node</r_node></port>
        </linklist>
        <linklist name="12x switch" width="12x">
                <port num="1"><r_port>1</r_port><r_node>12x node</r_node></port>
        </linklist>
        <subfabric width="1x" speed="SDR">
                <property name="color">blue</property>
                <!\-\- blue sub fabric \-\->
                <linklist name="1X SDR blue switch">
                        <port num="1"><r_port>2</r_port><r_node>SDR blue node</r_node></port>
                </linklist>
        </subfabric>
</ibfabric>
.ft P
.fi
.\" Common text to describe the Topology file.
.
.SS TOPOLOGY FILE FORMAT
.sp
The topology file format is human readable and largely intuitive.
Most identifiers are given textual names like vendor ID (vendid), device ID
(device ID), GUIDs of various types (sysimgguid, caguid, switchguid, etc.).
PortGUIDs are shown in parentheses ().  For switches, this is shown on the
switchguid line.  For CA and router ports, it is shown on the connectivity
lines.  The IB node is identified followed by the number of ports and a quoted
the node GUID.  On the right of this line is a comment (#) followed by the
NodeDescription in quotes.  If the node is a switch, this line also contains
whether switch port 0 is base or enhanced, and the LID and LMC of port 0.
Subsequent lines pertaining to this node show the connectivity.   On the
left is the port number of the current node.  On the right is the peer node
(node at other end of link). It is identified in quotes with nodetype
followed by \- followed by NodeGUID with the port number in square brackets.
Further on the right is a comment (#).  What follows the comment is
dependent on the node type.  If it it a switch node, it is followed by
the NodeDescription in quotes and the LID of the peer node.  If it is a
CA or router node, it is followed by the local LID and LMC and then
followed by the NodeDescription in quotes and the LID of the peer node.
The active link width and speed are then appended to the end of this
output line.
.sp
An example of this is:
.sp
.nf
.ft C
#
# Topology file: generated on Tue Jun  5 14:15:10 2007
#
# Max of 3 hops discovered
# Initiated from node 0008f10403960558 port 0008f10403960559

Non\-Chassis Nodes

vendid=0x8f1
devid=0x5a06
sysimgguid=0x5442ba00003000
switchguid=0x5442ba00003080(5442ba00003080)
Switch  24 "S\-005442ba00003080"         # "ISR9024 Voltaire" base port 0 lid 6 lmc 0
[22]    "H\-0008f10403961354"[1](8f10403961355)         # "MT23108 InfiniHost Mellanox Technologies" lid 4 4xSDR
[10]    "S\-0008f10400410015"[1]         # "SW\-6IB4 Voltaire" lid 3 4xSDR
[8]     "H\-0008f10403960558"[2](8f1040396055a)         # "MT23108 InfiniHost Mellanox Technologies" lid 14 4xSDR
[6]     "S\-0008f10400410015"[3]         # "SW\-6IB4 Voltaire" lid 3 4xSDR
[12]    "H\-0008f10403960558"[1](8f10403960559)         # "MT23108 InfiniHost Mellanox Technologies" lid 10 4xSDR

vendid=0x8f1
devid=0x5a05
switchguid=0x8f10400410015(8f10400410015)
Switch  8 "S\-0008f10400410015"          # "SW\-6IB4 Voltaire" base port 0 lid 3 lmc 0
[6]     "H\-0008f10403960984"[1](8f10403960985)         # "MT23108 InfiniHost Mellanox Technologies" lid 16 4xSDR
[4]     "H\-005442b100004900"[1](5442b100004901)        # "MT23108 InfiniHost Mellanox Technologies" lid 12 4xSDR
[1]     "S\-005442ba00003080"[10]                # "ISR9024 Voltaire" lid 6 1xSDR
[3]     "S\-005442ba00003080"[6]         # "ISR9024 Voltaire" lid 6 4xSDR

vendid=0x2c9
devid=0x5a44
caguid=0x8f10403960984
Ca      2 "H\-0008f10403960984"          # "MT23108 InfiniHost Mellanox Technologies"
[1](8f10403960985)     "S\-0008f10400410015"[6]         # lid 16 lmc 1 "SW\-6IB4 Voltaire" lid 3 4xSDR

vendid=0x2c9
devid=0x5a44
caguid=0x5442b100004900
Ca      2 "H\-005442b100004900"          # "MT23108 InfiniHost Mellanox Technologies"
[1](5442b100004901)     "S\-0008f10400410015"[4]         # lid 12 lmc 1 "SW\-6IB4 Voltaire" lid 3 4xSDR

vendid=0x2c9
devid=0x5a44
caguid=0x8f10403961354
Ca      2 "H\-0008f10403961354"          # "MT23108 InfiniHost Mellanox Technologies"
[1](8f10403961355)     "S\-005442ba00003080"[22]                # lid 4 lmc 1 "ISR9024 Voltaire" lid 6 4xSDR

vendid=0x2c9
devid=0x5a44
caguid=0x8f10403960558
Ca      2 "H\-0008f10403960558"          # "MT23108 InfiniHost Mellanox Technologies"
[2](8f1040396055a)     "S\-005442ba00003080"[8]         # lid 14 lmc 1 "ISR9024 Voltaire" lid 6 4xSDR
[1](8f10403960559)     "S\-005442ba00003080"[12]                # lid 10 lmc 1 "ISR9024 Voltaire" lid 6 1xSDR
.ft P
.fi
.sp
When grouping is used, IB nodes are organized into chassis which are
numbered. Nodes which cannot be determined to be in a chassis are
displayed as "Non\-Chassis Nodes".  External ports are also shown on the
connectivity lines.
.SS Utilities list
.SS Basic fabric conectivity
.INDENT 0.0
.INDENT 3.5
.sp
See: ibnetdiscover, iblinkinfo
.UNINDENT
.UNINDENT
.SS Node information
.INDENT 0.0
.INDENT 3.5
.sp
See: ibnodes, ibswitches, ibhosts, ibrouters
.UNINDENT
.UNINDENT
.SS Port information
.INDENT 0.0
.INDENT 3.5
.sp
See: ibportstate, ibaddr
.UNINDENT
.UNINDENT
.SS Switch Forwarding Table info
.INDENT 0.0
.INDENT 3.5
.sp
See: ibtracert, ibroute, dump_lfts, dump_mfts, check_lft_balance, ibfindnodesusing
.UNINDENT
.UNINDENT
.SS Peformance counters
.INDENT 0.0
.INDENT 3.5
.sp
See: ibqueryerrors, perfquery
.UNINDENT
.UNINDENT
.SS Local HCA info
.INDENT 0.0
.INDENT 3.5
.sp
See: ibstat, ibstatus
.UNINDENT
.UNINDENT
.SS Connectivity check
.INDENT 0.0
.INDENT 3.5
.sp
See: ibping, ibsysstat
.UNINDENT
.UNINDENT
.SS Low level query tools
.INDENT 0.0
.INDENT 3.5
.sp
See: smpquery, smpdump, saquery, sminfo
.UNINDENT
.UNINDENT
.SS Fabric verification tools
.INDENT 0.0
.INDENT 3.5
.sp
See: ibidsverify
.UNINDENT
.UNINDENT
.SS Backwards compatibility scripts
.sp
The following scripts have been identified as redundant and/or lower performing
as compared to the above scripts.  They are provided as legacy scripts when
\-\-enable\-compat\-utils is specified at build time.
.sp
ibcheckerrors, ibclearcounters, ibclearerrors, ibdatacounters
ibchecknet, ibchecknode, ibcheckport, ibcheckportstate,
ibcheckportwidth, ibcheckstate, ibcheckwidth, ibswportwatch,
ibprintca, ibprintrt, ibprintswitch, set_nodedesc.sh
.SS AUTHORS
.INDENT 0.0
.TP
.B Ira Weiny
.
<\fI\%weiny2@llnl.gov\fP>
.UNINDENT
.\" Generated by docutils manpage writer.
.\" 
.
